package store

import (
	"github.com/elahe-dastan/urlShortener_KGS/generator"
	"github.com/elahe-dastan/urlShortener_KGS/model"
	"github.com/jinzhu/gorm"
)

type ShortURL struct {
	DB *gorm.DB
}

// Connects to the database and saves all the random short urls generated by the key generator service in it
func (url ShortURL) Save() {
	if url.DB.HasTable(&model.ShortURL{}) {
		return
	}

	urls := generator.Generate()

	url.DB.Debug().AutoMigrate(&model.ShortURL{})

	for _, u := range urls {
		a := u
		url.DB.Create(&a)
	}
}

func (url ShortURL) Choose() string {
	var selectedURL model.ShortURL

	url.DB.Raw("UPDATE short_urls SET is_used = ? WHERE url = "+
		"(SELECT url FROM short_urls WHERE is_used = ? LIMIT 1) "+
		"RETURNING *;", true, false).Scan(&selectedURL) //O(lgn)

	return selectedURL.URL
}
